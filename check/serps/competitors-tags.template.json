{
      "query": {
        "bool": {
          "filter": [
            {
              "term": {
                "dashboard_id": $dashboardId
              }
            },
            {
              "term": {
                "provider": $source
              }
            },
            {
              "terms": {
                "hash":
                  $filteredHashes
              }
            }
          ],
          "should": [
            {
              "range": {
                "last_update": {
                  "gte": $formattedDateFrom,
                  "lte": $formattedDateFrom
                }
              }
            },
            {
              "range": {
                "last_update": {
                  "gte": $formattedDateTo,
                  "lte": $formattedDateTo
                }
              }
            }
          ],
          "minimum_should_match": 1
        }
      },
      "size": 0,
      "aggs": {
        "tags": {
          "filters": {
            "filters": $tagsFilters
          },
          "aggs": {
            "first_and_last_serp": {
              "filters": {
                "filters": {
                  "first_serp": {
                    "range": {
                      "last_update": {
                        "gte": $formattedDateFrom,
                        "lte": $formattedDateFrom
                      }
                    }
                  },
                  "last_serp": {
                    "range": {
                      "last_update": {
                        "gte": $formattedDateTo,
                        "lte": $formattedDateTo
                      }
                    }
                  }
                }
              },
              "aggs": {
                "nest_positions": {
                  "nested": {
                    "path": "positions"
                  },
                  "aggs": {
                    "organic": {
                      "filter": {
                        "range": {
                          "positions.block_pos": {
                            "gte": 1,
                            "lte": 100
                          }
                        }
                      },
                      "aggs": {
                        "target_top": {
                          "filters": {
                            "filters": $competitorFilters
                          }
                        },
                        "target": {
                          "filters": {
                            "filters": $competitorFiltersTerms
                          },
                          "aggs": {
                            "traffic": {
                              "sum": {
                                "field": "positions.stats.volume"
                              }
                            }
                          }
                        },
                        "total_traffic": {
                          "sum": {
                            "field": "positions.stats.volume"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
}
