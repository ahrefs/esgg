{
        "query":{
            "bool":{
                "filter":[
                    {
                        "term":{
                            "dashboard_id": $dashboardId
                        }
                    },
                    {
                        "term":{
                            "provider": $source
                        }
                    },
                    {
                        "range":{
                            "last_update":{
                                "gte": $formattedDateFrom,
                                "lte": $formattedDateTo
                            }
                        }
                    },
                    {
                        "terms": {
                            "hash": $filteredHashes
                        }
                    }
                ]
            }
        },
        "size":0,
        "aggs":{
            "daily":{
                "date_histogram":{
                    "field":"last_update",
                    "interval":"1d",
                    "format":"yyyy-MM-dd",
                    "extended_bounds":{
                        "min": $formattedDateFrom,
                        "max": $formattedDateTo
                    }
                },
                "aggs":{
                    "nest_positions":{
                        "nested":{
                            "path":"positions"
                        },
                        "aggs":{
                            "all_features":{
                                "terms":{
                                    "field":"positions.type",
                                    "size":100,
                                    "exclude": [
                                        "organic",
                                        "local_teaser",
                                        "local_pack"
                                    ]
                                },
                                "aggs": {
                                    "unique": {
                                        "reverse_nested": "emptyObject"
                                    }
                                }
                            },
                            "organic": {
                                "filter": {
                                    "range": {
                                        "positions.block_pos": {
                                            "gte": 1,
                                            "lte": 100
                                        }
                                    }
                                },
                                "aggs": {
                                    "total_traffic": {
                                        "sum": {
                                            "field": "positions.stats.volume"
                                        }
                                    },
                                    "target": {
                                        "filter": {
                                            "term": {
                                                "positions.url_hash.$mode": $mode
                                            }
                                        },
                                        "aggs": {
                                            "traffic": {
                                                "sum": {
                                                    "field": "positions.stats.volume"
                                                }
                                            }
                                        }
                                    },
                                    "target_top_pos": {
                                        "filter": {
                                            "bool": {
                                                "filter": {
                                                    "term": {
                                                        "positions.url_hash.$mode": $mode
                                                    }
                                                },
                                                "must_not": {
                                                    "term": {
                                                        "positions.url_hash.exclude.$mode": $mode
                                                    }
                                                }
                                            }
                                        },
                                        "aggs": {
                                            "avg_pos": {
                                                "avg": {
                                                    "field": "positions.block_pos"
                                                }
                                            },
                                            "positions":{
                                                "filters":{
                                                    "other_bucket_key": "51-100",
                                                    "filters":{
                                                        "1-3":{
                                                            "terms":{
                                                                "positions.block_pos":[1,2,3]
                                                            }
                                                        },
                                                        "4-10":{
                                                            "terms":{
                                                                "positions.block_pos":[4,5,6,7,8,9,10]
                                                            }
                                                        },
                                                        "11-50":{
                                                            "range":{
                                                                "positions.block_pos":{
                                                                    "gt":10,
                                                                    "lte":50
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            },
                            "target": {
                                "filter": {
                                    "term": {
                                        "positions.url_hash.$mode": $mode
                                    }
                                },
                                "aggs": {
                                    "features": {
                                        "terms": {
                                            "field": "positions.type",
                                            "size": 100,
                                            "exclude": [
                                                "organic",
                                                "local_teaser",
                                                "local_pack"
                                            ]
                                        },
                                        "aggs": {
                                            "unique": {
                                                "reverse_nested": "emptyObject"
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
}
